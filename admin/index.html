<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --sidebar-bg: #1f2937;
            --sidebar-text: #e5e7eb;
            --card-bg: #ffffff;
            --text: #111827;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sidebar-bg); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 2rem; border-radius: 8px; width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;
        }
        .login-box input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* Main Layout */
        #app-container { display: flex; width: 100%; height: 100%; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        #app-container.active { visibility: visible; opacity: 1; }

        /* Sidebar */
        aside { width: 250px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #374151; }
        nav { flex: 1; padding: 10px; overflow-y: auto; }
        nav button {
            background: none; border: none; color: var(--sidebar-text); width: 100%; text-align: left;
            padding: 12px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; font-size: 1rem;
        }
        nav button:hover, nav button.active { background: #374151; color: white; }
        .logout-btn { margin-top: auto; padding: 15px; background: #111827; color: #ef4444; text-align: center; cursor: pointer; }

        /* Content */
        main { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .add-btn { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card {
            background: var(--card-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s; position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-img { height: 160px; background: #e5e7eb; object-fit: cover; width: 100%; }
        .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; }
        .card-links { margin-top: auto; display: flex; flex-direction: column; gap: 8px; }
        .link-item { font-size: 0.9rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .link-item:hover { text-decoration: underline; }
        .card-actions { 
            position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; 
            opacity: 0; transition: opacity 0.2s; 
        }
        .card:hover .card-actions { opacity: 1; }
        .action-btn { background: rgba(255,255,255,0.9); border: none; border-radius: 4px; padding: 5px 8px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 500; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: white; width: 500px; max-width: 90%; border-radius: 8px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #9ca3af; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .tab-btn { background: none; border: none; padding: 5px 10px; cursor: pointer; color: #666; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-color: var(--primary); }

        /* Spinner */
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 20px; border-radius: 8px; display: none; z-index: 2000; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h2>–í—Ö–æ–¥</h2>
            <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="Auth.login()">–í–æ–π—Ç–∏</button>
            <p id="login-error" style="color:red; font-size: 0.8rem; display:none;">–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
        </div>
    </div>

    <!-- App -->
    <div id="app-container">
        <aside>
            <div class="brand">Material Base</div>
            <nav id="sections-nav">
                <!-- Sections will be generated here -->
            </nav>
            <div class="logout-btn" onclick="Auth.logout()">–í—ã—Ö–æ–¥</div>
        </aside>

        <main>
            <header>
                <h2 id="current-section-title">–†–∞–∑–¥–µ–ª</h2>
                <button class="add-btn" onclick="CardManager.openModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
            </header>
            <div id="cards-grid" class="grid">
                <!-- Cards will be generated here -->
            </div>
        </main>
    </div>

    <!-- Modal Form -->
    <div class="modal-overlay" id="card-modal">
        <div class="modal">
            <h3 id="modal-title">–ö–∞—Ä—Ç–æ—á–∫–∞</h3>
            <form id="card-form" onsubmit="event.preventDefault(); CardManager.save();">
                <input type="hidden" id="card-id">
                
                <div class="form-group">
                    <label>–†–∞–∑–¥–µ–ª</label>
                    <select id="card-section" required></select>
                </div>

                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="card-title" required>
                </div>

                <div class="form-group">
                    <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ</label>
                    <input type="url" id="card-video" placeholder="https://rutube.ru/...">
                </div>

                <div class="form-group">
                    <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
                    <input type="file" id="card-image-file" accept="image/*" onchange="CardManager.handleImagePreview(this)">
                    <input type="hidden" id="card-image-base64">
                    <input type="hidden" id="card-image-mime">
                    <input type="hidden" id="card-image-name">
                    <input type="hidden" id="card-image-url-current">
                    <div id="image-preview" style="margin-top:5px; max-height: 100px; display:none;"></div>
                </div>

                <div class="form-group">
                    <label>PDF –î–æ–∫—É–º–µ–Ω—Ç</label>
                    <div class="tabs">
                        <button type="button" class="tab-btn active" onclick="CardManager.switchPdfTab('select')">–í—ã–±—Ä–∞—Ç—å –∏–∑ –¥–∏—Å–∫–∞</button>
                        <button type="button" class="tab-btn" onclick="CardManager.switchPdfTab('upload')">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                    </div>

                    <!-- Tab 1: Select from Drive -->
                    <div id="pdf-tab-select">
                        <select id="card-pdf-select">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                        </select>
                    </div>

                    <!-- Tab 2: Upload File -->
                    <div id="pdf-tab-upload" style="display:none;">
                        <input type="file" id="card-pdf-file" accept="application/pdf">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="CardManager.closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

        <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const CREDENTIALS = { login: 'admin', pass: '12345' }; 
        // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î –í–ê–®–£ –°–°–´–õ–ö–£ –ù–ê WEB APP
        const GAS_APP_URL = 'https://script.google.com/macros/s/AKfycbyQBWZZRrIGT6HIy78uvYqNqqo2CDISHIqOPMPTEG1mCvH4gxEn9QJXqlYaHVAV0zBu/exec';

        // –°—Å—ã–ª–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ (–µ—Å–ª–∏ —Ä–∞–∑–¥–µ–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–º—è—Ç–∏)
        const MAIN_PAGE_URL = 'https://wedophoto.github.io/lego/'; 

        // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---
        let state = {
            cards: [],
            pdfFilesMap: {},
            currentSection: '', // –ë—É–¥–µ—Ç –∑–∞–¥–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
            sections: []        // –°—é–¥–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —Ä–∞–∑–¥–µ–ª—ã –∏–∑ LocalStorage –∏–ª–∏ –ø–∞—Ä—Å–µ—Ä–∞
        };

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
                // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        const Auth = {
            login: async () => {
                const l = document.getElementById('login').value;
                const p = document.getElementById('password').value;

                if (!l || !p) {
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').innerText = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const btn = document.querySelector('.login-box button');
                const originalText = btn.innerText;
                btn.innerText = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                btn.disabled = true;

                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è
                    const res = await fetch(GAS_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'login',
                            username: l, // –õ–æ–≥–∏–Ω –ø–æ–∫–∞ –Ω–∏ –Ω–∞ —á—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç, –Ω–æ —à–ª–µ–º –µ–≥–æ
                            password: p
                        })
                    });
                    
                    const result = await res.json();
                    
                    if (result.status === 'success') {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app-container').classList.add('active');
                        App.init();
                    } else {
                        document.getElementById('login-error').style.display = 'block';
                        document.getElementById('login-error').innerText = result.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                    }

                } catch (e) {
                    console.error(e);
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').innerText = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            },
            logout: () => { location.reload(); }
        };
        // --- –ü–ê–†–°–ï–† –°–ï–ö–¶–ò–ô ---
        const SectionParser = {
            parse: async () => {
                try {
                    console.log('üîç –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
                    const response = await fetch(MAIN_PAGE_URL);
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    const text = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    
                    const cards = doc.querySelectorAll('.category-card');
                    const parsedSections = [];
                    
                    cards.forEach(card => {
                        const href = card.getAttribute('href');
                        const nameEl = card.querySelector('.category-name');
                        if (href && nameEl) {
                            let id = href.includes('/') ? href.substring(href.lastIndexOf('/') + 1) : href;
                            if (id.endsWith('.htm')) id = id.replace('.htm', '');
                            
                            parsedSections.push({ id: id, name: nameEl.innerText.trim() });
                        }
                    });

                    if (parsedSections.length > 0) {
                        localStorage.setItem('site_sections', JSON.stringify(parsedSections));
                        state.sections = parsedSections;
                        console.log(`‚úÖ –†–∞–∑–¥–µ–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã (${parsedSections.length} —à—Ç.)`);
                    }
                } catch (e) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã:', e);
                    // –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è, —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
                    if (state.sections.length === 0) {
                        state.sections = [{id: 'general', name: '–û–±—â–µ–µ'}];
                    }
                }
            }
        };

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        const App = {
            init: async () => {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã
                const storedSections = localStorage.getItem('site_sections');
                if (storedSections) {
                    state.sections = JSON.parse(storedSections);
                    console.log('üìÇ –†–∞–∑–¥–µ–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏');
                } else {
                    // –ï—Å–ª–∏ –≤ –ø–∞–º—è—Ç–∏ –ø—É—Å—Ç–æ - –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä
                    await SectionParser.parse();
                }

                if (state.sections.length === 0) {
                    alert('–°–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ –ø—É—Å—Ç!');
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ–∫—Ü–∏—é (–ø–µ—Ä–≤—É—é –≤ —Å–ø–∏—Å–∫–µ)
                state.currentSection = state.sections[0].id;

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                UI.renderSidebar(); // –†–∏—Å—É–µ–º –º–µ–Ω—é
                await Promise.all([App.loadCards(), App.loadPdfList()]);
                
                // 3. –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏
                UI.renderCards(state.currentSection);
            },

                        loadCards: async () => {
                console.log('üîÑ –ó–ê–ü–£–°–ö –ó–ê–ì–†–£–ó–ö–ò –ö–ê–†–¢–û–ß–ï–ö...');
                try {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –∏ —Å—Ä–∞–∑—É –≤—ã–≤–æ–¥–∏–º –µ–≥–æ
                    const cacheBuster = '&t=' + Date.now();
                    const url = GAS_APP_URL + '?action=getCards' + cacheBuster;
                    
                    console.log('%cüåê –ó–∞–ø—Ä–æ—Å –ø–æ —Å—Å—ã–ª–∫–µ:', 'color: blue; font-weight: bold;');
                    console.log(url);

                    const res = await fetch(url);
                    
                    console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', res.status);
                    
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                    const data = await res.json();
                    
                    console.log('–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', typeof data);
                    console.log('–ü–µ—Ä–≤—ã–π –∫–ª—é—á (–µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç):', Object.keys(data)[0]);

                    if (Array.isArray(data)) {
                        state.cards = data;
                        localStorage.setItem('site_cards', JSON.stringify(data));
                        console.log(`‚úÖ –£—Å–ø–µ—Ö! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –∫–∞—Ä—Ç–æ—á–µ–∫.`);
                        UI.renderCards(state.currentSection);
                    } else {
                        console.error('‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–∏—à–µ–ª –Ω–µ –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫, –∞ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ.');
                        console.error('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    }

                } catch (e) {
                    console.error('üí• –û—à–∏–±–∫–∞:', e);
                }
            },

            loadPdfList: async () => {
                try {
                    const res = await fetch(GAS_APP_URL + '?action=getFilesList');
                    if (res.ok) {
                        const data = await res.json();
                        state.pdfFilesMap = data;
                        localStorage.setItem('drivePdfMap', JSON.stringify(data));
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ PDF", e);
                }
            }
        };

        // --- –ú–ï–ù–ï–î–ñ–ï–† –ö–ê–†–¢–û–ß–ï–ö ---
        const CardManager = {
            currentPdfMode: 'select',

            openModal: (editCardId = null) => {
                const modal = document.getElementById('card-modal');
                const form = document.getElementById('card-form');
                const titleEl = document.getElementById('modal-title');
                
                form.reset();
                document.getElementById('image-preview').innerHTML = '';
                document.getElementById('image-preview').style.display = 'none';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Å–µ–∫—Ü–∏–π (–ò–°–ü–û–õ–¨–ó–£–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –°–ü–ò–°–û–ö)
                const sectionSelect = document.getElementById('card-section');
                sectionSelect.innerHTML = state.sections.map(s => 
                    `<option value="${s.id}">${s.name}</option>`
                ).join('');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç PDF
                const pdfSelect = document.getElementById('card-pdf-select');
                pdfSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...</option>' + 
                    Object.keys(state.pdfFilesMap).map(name => 
                        `<option value="${state.pdfFilesMap[name]}">${name}</option>`
                    ).join('');

                if (editCardId) {
                    const card = state.cards.find(c => c.id === editCardId);
                    titleEl.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
                    document.getElementById('card-id').value = card.id;
                    document.getElementById('card-section').value = card.section;
                    document.getElementById('card-title').value = card.title;
                    document.getElementById('card-video').value = card.videoUrl || '';
                    
                    if (card.imageUrl) {
                        document.getElementById('card-image-url-current').value = card.imageUrl;
                        document.getElementById('image-preview').innerHTML = `<img src="${card.imageUrl}" style="max-height:100px;">`;
                        document.getElementById('image-preview').style.display = 'block';
                    }

                    if (card.pdf && card.pdf.id) {
                        const foundInMap = Object.keys(state.pdfFilesMap).find(key => state.pdfFilesMap[key] === card.pdf.id);
                        if (foundInMap) {
                            pdfSelect.value = card.pdf.id;
                        } else {
                            const opt = document.createElement('option');
                            opt.value = card.pdf.id;
                            opt.text = card.pdf.name || '–§–∞–π–ª';
                            opt.selected = true;
                            pdfSelect.add(opt);
                        }
                    }
                } else {
                    titleEl.textContent = '–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞';
                    document.getElementById('card-id').value = '';
                    document.getElementById('card-section').value = state.currentSection;
                }

                modal.classList.add('open');
            },

            closeModal: () => {
                document.getElementById('card-modal').classList.remove('open');
            },

            switchPdfTab: (mode) => {
                CardManager.currentPdfMode = mode;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                if (mode === 'select') {
                    document.getElementById('pdf-tab-select').style.display = 'block';
                    document.getElementById('pdf-tab-upload').style.display = 'none';
                } else {
                    document.getElementById('pdf-tab-select').style.display = 'none';
                    document.getElementById('pdf-tab-upload').style.display = 'block';
                }
            },

            handleImagePreview: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('image-preview').innerHTML = `<img src="${e.target.result}" style="max-height:100px;">`;
                        document.getElementById('image-preview').style.display = 'block';
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            },

            fileToBase64: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve({
                        base64: reader.result.split(',')[1],
                        mime: file.type,
                        name: file.name
                    });
                    reader.onerror = error => reject(error);
                });
            },

            save: async () => {
                UI.showLoader(true);
                try {
                    const id = document.getElementById('card-id').value;
                    const section = document.getElementById('card-section').value;
                    const title = document.getElementById('card-title').value;
                    const videoUrl = document.getElementById('card-video').value;
                    
                    const imageFile = document.getElementById('card-image-file').files[0];
                    let imagePayload = {};
                    if (imageFile) imagePayload = await CardManager.fileToBase64(imageFile);

                    let pdfPayload = { id: '', name: '' };
                    if (CardManager.currentPdfMode === 'select') {
                        const select = document.getElementById('card-pdf-select');
                        if (select.value) {
                            pdfPayload.id = select.value;
                            pdfPayload.name = select.options[select.selectedIndex].text;
                        }
                    } else {
                        const pdfFile = document.getElementById('card-pdf-file').files[0];
                        if (pdfFile) {
                            const pdfData = await CardManager.fileToBase64(pdfFile);
                            pdfPayload.base64 = pdfData.base64;
                            pdfPayload.name = pdfData.name;
                        }
                    }

                    const payload = {
                        action: 'saveCard',
                        card: {
                            id: id || null,
                            section: section,
                            title: title,
                            videoUrl: videoUrl,
                            imageBase64: imagePayload.base64 || null,
                            imageMimeType: imagePayload.mime || null,
                            imageName: imagePayload.name || null,
                            imageUrl: id ? document.getElementById('card-image-url-current').value : null,
                            pdfId: pdfPayload.id || null,
                            pdfName: pdfPayload.name || null,
                            pdfBase64: pdfPayload.base64 || null
                        }
                    };

                    const response = await fetch(GAS_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        state.cards = result.data;
                        localStorage.setItem('site_cards', JSON.stringify(state.cards));
                        UI.renderCards(state.currentSection);
                        CardManager.closeModal();
                        alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + result.message);
                    }

                } catch (e) {
                    console.error(e);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
                } finally {
                    UI.showLoader(false);
                }
            },

            deleteCard: async (id) => {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?')) return;

                UI.showLoader(true);
                try {
                    const res = await fetch(GAS_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'deleteCard',
                            id: id
                        })
                    });
                    
                    const result = await res.json();
                    
                    if (result.status === 'success') {
                        state.cards = result.data;
                        localStorage.setItem('site_cards', JSON.stringify(state.cards));
                        UI.renderCards(state.currentSection);
                        // alert('–£–¥–∞–ª–µ–Ω–æ');
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + result.message);
                    }

                } catch (e) {
                    console.error(e);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.');
                } finally {
                    UI.showLoader(false);
                }
            },
        };

        // --- UI –†–ï–ù–î–ï–†–ò–ù–ì ---
        const UI = {
            renderSidebar: () => {
                const nav = document.getElementById('sections-nav');
                // –ò–°–ü–û–õ–¨–ó–£–ï–ú state.sections –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø
                nav.innerHTML = state.sections.map(s => 
                    `<button onclick="UI.changeSection('${s.id}')" class="${s.id === state.currentSection ? 'active' : ''}">${s.name}</button>`
                ).join('');
            },

            changeSection: (sectionId) => {
                state.currentSection = sectionId;
                UI.renderSidebar();
                UI.renderCards(sectionId);
            },

            renderCards: (sectionId) => {
                // –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ ID
                const currentSectionObj = state.sections.find(s => s.id === sectionId);
                const sectionName = currentSectionObj ? currentSectionObj.name : '–†–∞–∑–¥–µ–ª';
                
                document.getElementById('current-section-title').textContent = sectionName;
                
                const grid = document.getElementById('cards-grid');
                const filtered = state.cards.filter(c => c.section === sectionId);
                
                if (filtered.length === 0) {
                    grid.innerHTML = '<p style="color:#666; grid-column: 1/-1; text-align:center;">–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.</p>';
                    return;
                }

                grid.innerHTML = filtered.map(card => {
                                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ ID, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π (preview)
            // –°—Å—ã–ª–∫–∞ –Ω–∞ PDF (–æ–±–µ—Ä–Ω—É—Ç–∞ –≤ —Ç–µ–≥ <a>)
            const pdfLink = card.pdf && card.pdf.id 
                ? `<a href="https://drive.google.com/file/d/${card.pdf.id}/preview" target="_blank" class="link-item">üìÑ ${card.pdf.name || '–î–æ–∫—É–º–µ–Ω—Ç'}</a>` 
                : '';
                    const videoLink = card.videoUrl 
                        ? `<a href="${card.videoUrl}" target="_blank" class="location-item">üé¨ –í–∏–¥–µ–æ</a>` 
                        : '';

                    return `
                    <div class="card">
                        <div class="card-actions">
                            <button class="action-btn" onclick="CardManager.openModal('${card.id}')">‚úé</button>
                            <button class="action-btn" style="color: red;" onclick="CardManager.deleteCard('${card.id}')">üóëÔ∏è</button>
                        </div>
                        ${card.imageUrl ? `<img src="${card.imageUrl}" class="card-img" alt="${card.title}">` : '<div class="card-img"></div>'}
                        <div class="card-body">
                            <div class="card-title">${card.title}</div>
                            <div class="card-links">
                                ${pdfLink}
                                ${videoLink}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            showLoader: (show) => {
                document.getElementById('loader').style.display = show ? 'block' : 'none';
            }
        };
    </script>
</body>
</html>